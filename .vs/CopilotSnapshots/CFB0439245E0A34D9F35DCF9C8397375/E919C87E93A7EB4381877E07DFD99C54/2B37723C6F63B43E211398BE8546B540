using Biblioteca.Api.Data;
using Biblioteca.Api.DTOs;
using Biblioteca.Api.Models;
using Biblioteca.Api.Services;
using Biblioteca.Api.Services.Interfaces;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Storage;
using Microsoft.Extensions.Logging;
using System.Globalization;

namespace Biblioteca.Api.Services
{
    public class UsuarioService : IUsuarioService
    {
        private readonly ApplicationDbContext _context;
        private readonly ILogger<UsuarioService> _logger;

        public UsuarioService(ApplicationDbContext context, ILogger<UsuarioService> logger)
        {
            _context = context;
            _logger = logger;
        }

        public async Task<Usuario?> GetUsuarioByIdAsync(int id)
        {
            return await _context.Usuarios.FindAsync(id);
        }

        public async Task<Usuario> CadastrarNovoUsuario(UsuarioCadastroDto dto)
        {

            using (IDbContextTransaction transaction = await _context.Database.BeginTransactionAsync())
            {

                try
                {
                    var novoEndereco = new Endereco
                    {
                        CEP = dto.Cep,
                        Rua = dto.Rua,
                        Cidade = dto.Cidade,
                        Bairro = dto.Bairro,
                        Estado = dto.Estado
                    };
                    
                    _context.Enderecos.Add(novoEndereco);
                    await _context.SaveChangesAsync();

                    // Parse DataNascimento from DTO (string) to DateTime
                    DateTime dataNascimento;
                    if (!DateTime.TryParse(dto.DataNascimento, CultureInfo.GetCultureInfo("pt-BR"), DateTimeStyles.None, out dataNascimento)
                        && !DateTime.TryParse(dto.DataNascimento, CultureInfo.InvariantCulture, DateTimeStyles.None, out dataNascimento))
                    {
                        // Try common formats
                        var formats = new[] { "dd/MM/yyyy", "yyyy-MM-dd", "yyyy/MM/dd" };
                        if (!DateTime.TryParseExact(dto.DataNascimento, formats, CultureInfo.InvariantCulture, DateTimeStyles.None, out dataNascimento))
                        {
                            throw new ArgumentException("DataNascimento inválida: formato não reconhecido.");
                        }
                    }

                    var novoUsuario = new Usuario
                    {
                        Nome = dto.Nome,
                        CPF = dto.CPF,
                        DataNascimento = dataNascimento,
                        DataCadastro = DateTime.UtcNow,
                        EnderecoId = novoEndereco.Id
                    };
                    _context.Usuarios.Add(novoUsuario);
                    await _context.SaveChangesAsync();

                    var senhaHash = BCrypt.Net.BCrypt.HashPassword(dto.Senha);

                    var novoLogin = new Login
                    {
                        Email = dto.Email,
                        Username = dto.Username,
                        Senha = senhaHash,
                        Inativo = false,
                        DataCriacao = DateTime.UtcNow,
                        UsuarioId = novoUsuario.Id
                    };
                    _context.Logins.Add(novoLogin);
                    await _context.SaveChangesAsync();

                    return novoUsuario;
                }
                catch (Exception ex)
                {
                    await transaction.RollbackAsync();
                    throw ex.InnerException ?? ex;
                }
            }
        }

    }
}
